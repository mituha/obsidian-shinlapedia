# ShinLapedia プラグイン仕様書

## コンセプト

ユーザーは辞典を読むようにリンクを辿って単語とその意味を見ることができます。
リンクを辿る際、未作成の単語はマークダウンファイルとして作成されます。
ファイルが新規作成された場合に、その単語に対する意味を生成AIを利用して生成します。

## 主な機能

- **単語ページの自動生成**: 存在しない単語へのリンクをクリックすると、その単語のMarkdownファイルが自動的に作成されます。
- **AIによる語彙情報生成**: 新規作成された単語ページに対して、GoogleのGemini APIを利用して語彙情報を自動生成し、ファイルに書き込みます。
- **柔軟な辞典設定**: ユーザーは辞典のタイトルや説明、編纂者の名前や背景などを設定でき、AIが生成する内容に文���を付与できます。
- **編纂者とのチャット**: 現在開いている単語の文脈を踏まえて、AI（編纂者）と対話できます。

## 編纂者とのチャット

サイドバーにチャットビューが追加され、AIである編纂者と対話することができます。

- **コンテキスト認識**: チャットは現在アクティブなMarkdownエディタの内容をコンテキストとして認識します。これにより、ユーザーが開いている単語ページに関連する質問や議論をスムーズに行うことができます。
- **コマンド**: 「編纂者とチャット」コマンドを実行するか、リボンアイコンをクリックすることでチャットビューを開くことができます。
- **実装**:
    - UI: `src/ui/ChatView.ts`
    - AIロジック: `src/services/geminiService.ts` の `generateChatResponse` 関数

## AIによる語彙情報生成の仕様

AIは以下のプロンプトに基づき、指定された単語の語彙情報をJSON形式で生成します。
使用するAIモデルは `gemini-2.5-flash` です。
SDKは `@google/genai` を使用していま���。

### プロンプトの基本構造

```
あなたは辞典の編纂者です。
「{word}」について、以下のJSONスキーマに従って日本語で詳細な語彙情報を生成してください。

[オプション設定に応じた追加指示]

基本的にこの辞典特有の意味を優先します。
一般的な意味がある場合はわかるように併記してください。
意味(definition)よりフレーバーテキスト(flavorText)が適切な場合は、意味ではなくフレーバーテキストを記述してください。
意味、フレーバーテキストの項目は冗長になりすぎないように140文字以内で記述してください。
ルビを振る場合、 |漢字《かんじ》 の形式で記述してください。
現在の単語以外のこの辞典特有の固有単語には、 [固有単語](固有単語.md) の形式でリンクを記述してください。なお、リンク先にはルビを含めないでください。
類義語、対義語、関連語の項目のリンク記述は不要です。
```

- `{word}`: ユーザーが指定した単語。

### オプション設定

以下��設定項目が有効な場合、プロンプトに追加の指示が与えられます。

- **辞典のタイトル**: `辞典「{bookTitle}」の文脈で説明してください。`
- **辞典の説明**: `辞典の説明: {bookDescription}。`
- **編纂者名**: `編纂者「{authorName}」の視点から説明してください。`
- **編纂者の説明**: `編纂者の説明: {authorDescription}。`

### JSONスキーマ (`LexicalEntry`)

AIが生成するJSONは、以下の構造に従います。

| プロパティ名 | 型 | 説明 | 必須 |
| --- | --- | --- | --- |
| `lemma` | STRING | 見出し語 | ✅ |
| `reading` | STRING | 語の読み方や発音 | |
| `partOfSpeech` | STRING | 品詞 | ✅ |
| `definitions` | ARRAY[STRING] | 語の定義の配列 | ✅ |
| `flavorText` | STRING | フレーバーテキストや補足情報 | |
| `etymology` | STRING | 語源 | |
| `examples` | ARRAY[OBJECT] | 例文 | |
| `examples.sentence` | STRING | 例文の文 | ✅ |
| `examples.source` | STRING | 例文の出典 | |
| `synonyms` | ARRAY[STRING] | 類義語 | |
| `antonyms` | ARRAY[STRING] | 対義語 | |
| `tags` | ARRAY[STRING] | タグやラベル | |

## クラス構成

- `ShinLapediaPlugin`: プラグインのメインクラス。イベントリスナーやコマンドを登録します。
- `shinLapediaSettings`: プラグインの設定を管理するクラス。
- `shinLapediaSettingsTab`: 設定画面のUIを構築するクラス。
- `geminiService`: Gemini APIとの通信を担当するサービスクラス。
- `LexicalEntry`: 語彙情報のデータ構造を定義するモデルクラス。
- `LexicalEntryFormatter`: `LexicalEntry`オブジェクトをMarkdown形式に変換するクラス。
- `ChatView`: 編纂者とのチャット機能のUIを構築するクラス。

## ルビ・傍点機能

Markdownファイル内のカクヨム記法で記述されたルビ（振り仮名）と傍点を、HTMLタグに自動的に変換します。
この機能は[カクヨムのヘルプセンター](https://kakuyomu.jp/help/entry/notation)で説明されている記法に準拠しています。
処理はObsidianのMarkdownポストプロセッサーを利用して実現されます。

### 書式

#### ルビ

1.  **区切り文字を使用する方法**
    -   **書式**: `|親文字��ルビ》` または `｜親文字《ルビ》`
    -   **説明**: 親文字の前に半角または全角の縦線 `|` を入れます。この方法では、漢字、ひらがな、カタカナ、英数字など、あらゆる文字を親文字にできます。
    -   **例**: `|etc《えとせとら》` → `<ruby>etc<rt>えとせとら</rt></ruby>`

2.  **区切り文字を使用しない方法**
    -   **書式**: `親文字《ルビ》`
    -   **説明**: 親文字が**漢字のみ**で構成されている場合、区切り文字なしでルビを振ることができます。
    -   **例**: `彼女《ヒロイン》` → `<ruby>彼女<rt>ヒロイン</rt></ruby>`

#### 傍点

-   **書式**: `《《対象文字列》》`
-   **説明**: 傍点を振りたい文字列を二重の二重山括弧 `《《》》` で囲みます。
-   **出力 (HTML)**: `<em class="emphasis-dot">対象文字列</em>`
    -   傍点の表示は、`styles.css`で定義されたCSSによって制御されます。

### 実装

-   変換処理は `services/rubyTextFormatter.ts` 内の `applyRubyToElement` 関数で実装されています。
-   この関数は、指定されたHTML要素内のテキストを走査し、`formatRuby`関数を利用してカクヨム記法をHTMLタグに変換します。
-   `main.ts` の `registerMarkdownPostProcessor` 内で `applyRubyToElement` が呼び出され、Markdownのレンダリング時に自動的に変換が適用されます。

---

本仕様は現在の実装に基づいています。